name: "Release on merge to main"

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  release:
    if: ${{ github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main' }}
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout merge commit (full history)"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.merge_commit_sha }}

      - name: "Guard: must target main"
        run: |
          echo "Base branch: ${{ github.event.pull_request.base.ref }}"
          test "${{ github.event.pull_request.base.ref }}" = "main"

      - name: "Read release spec"
        id: spec
        run: |
          set -euo pipefail
          SPEC=".github/release-spec.md"
          if [ ! -f "$SPEC" ]; then
            echo "missing=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          TITLE="$(grep -E '^Release Title:' "$SPEC" | sed 's/^Release Title:[[:space:]]*//')"
          TAG="$(grep -E '^Release Tag Number:' "$SPEC" | sed 's/^Release Tag Number:[[:space:]]*//')"
          BASENAME="$(grep -E '^Custom File Name:' "$SPEC" | sed 's/^Custom File Name:[[:space:]]*//')"
          
          if grep -Eq '^(\[x\]|\[X\]) No Changelog' "$SPEC"; then NO_CHANGELOG=true; else NO_CHANGELOG=false; fi
          if grep -Eq '^(\[x\]|\[X\]) Pre-Release' "$SPEC"; then PRE_RELEASE=true; else PRE_RELEASE=false; fi
          
          MANUAL_BODY="$(awk '/^---CONTENT---/{flag=1;next}/^---END---/{flag=0}flag' "$SPEC")"
          
          if [ -z "$TITLE" ] || [ -z "$TAG" ] || [ -z "$BASENAME" ]; then
            echo "missing=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          echo "missing=false"              >> "$GITHUB_OUTPUT"
          echo "title=$TITLE"               >> "$GITHUB_OUTPUT"
          echo "tag=$TAG"                   >> "$GITHUB_OUTPUT"
          echo "basename=$BASENAME"         >> "$GITHUB_OUTPUT"
          echo "no_changelog=$NO_CHANGELOG" >> "$GITHUB_OUTPUT"
          echo "pre_release=$PRE_RELEASE"   >> "$GITHUB_OUTPUT"
          
          # multiline output for MANUAL_BODY (unique delimiter)
          DELIM="MANUAL_$(date +%s)_$$"
          {
            echo "manual_body<<$DELIM"
            printf '%s\n' "$MANUAL_BODY"
            echo "$DELIM"
          } >> "$GITHUB_OUTPUT"

      - name: "Stop if no valid spec"
        if: steps.spec.outputs.missing == 'true'
        run: echo "No valid .github/release-spec.md – skipping release."


      - name: "Set up JDK (Temurin 21, cache Maven)"
        if: steps.spec.outputs.missing == 'false'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: "Build (skip tests for speed)"
        if: steps.spec.outputs.missing == 'false'
        run: mvn -B -ntp -DskipTests clean package

      - name: "Find built jar (exclude sources/javadoc)"
        if: steps.spec.outputs.missing == 'false'
        id: jar
        run: |
          set -euo pipefail
          file="$(ls -1 target/*.jar | grep -v -E 'sources|javadoc' | head -n1)"
          echo "file=$file" >> "$GITHUB_OUTPUT"

      - name: "Rename artifact to custom file name"
        if: steps.spec.outputs.missing == 'false'
        id: jar_named
        run: |
          set -euo pipefail
          base="${{ steps.spec.outputs.basename }}"
          base="${base%.jar}"                                         # strip accidental .jar
          safe_base="$(printf '%s' "$base" | tr -cd '[:alnum:]._ -')" # sanitize
          [ -z "$safe_base" ] && safe_base="DiscordLogger"
          dest="target/${safe_base}.jar"
          cp "${{ steps.jar.outputs.file }}" "$dest"
          echo "file=$dest" >> "$GITHUB_OUTPUT"

      - name: "Label integration PR as skip-changelog"
        if: steps.spec.outputs.missing == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: ['skip-changelog']
            });

      - name: "Determine previous main release baseline"
        if: steps.spec.outputs.missing == 'false'
        id: prev
        run: |
          set -euo pipefail
          git fetch --tags --force
          prevTag="$(git tag --list 'v[0-9]*.[0-9]*.[0-9]*' --merged origin/main | sort -V | tail -n 1 || true)"
          if [ -n "$prevTag" ]; then
            prevRef="$prevTag"
            prevSha="$(git rev-list -n 1 "$prevTag")"
          else
            prevSha="$(git rev-list --max-parents=0 origin/main)"
            prevRef="$prevSha"
          fi
          echo "tag=$prevTag" >> "$GITHUB_OUTPUT"
          echo "sha=$prevSha" >> "$GITHUB_OUTPUT"
          echo "ref=$prevRef" >> "$GITHUB_OUTPUT"

      - name: "Create annotated tag (fallback if exists)"
        if: steps.spec.outputs.missing == 'false'
        id: tag
        run: |
          set -euo pipefail
          TAG="${{ steps.spec.outputs.tag }}"
          if git rev-parse -q --verify "refs/tags/$TAG" >/dev/null; then
            TAG="${TAG}-r${GITHUB_RUN_NUMBER}"
            echo "Existing tag found, using fallback: $TAG"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "${{ steps.spec.outputs.title }}"
          git push origin "$TAG"

      - name: "Build changelog (auto between tags)"
        if: steps.spec.outputs.missing == 'false' && steps.spec.outputs.no_changelog != 'true'
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v6
        with:
          configuration: .github/release-changelog-builder-config.json
          fromTag: ${{ steps.prev.outputs.tag }}
          toTag:   ${{ steps.tag.outputs.tag }}
          fetchViaCommits: "true"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "Assemble release body → RELEASE_BODY.md"
        if: steps.spec.outputs.missing == 'false'
        run: |
          set -euo pipefail
          : > RELEASE_BODY.md

          if [ -n "${MANUAL:-}" ]; then
            printf "%s\n" "${MANUAL}" >> RELEASE_BODY.md
          fi

          if [ "${NO_CHANGELOG:-false}" != "true" ] && [ -n "${AUTO_CHANGELOG:-}" ]; then
            if [ -s RELEASE_BODY.md ]; then
              printf "\n\n# Changelog\n\n" >> RELEASE_BODY.md
            fi
            printf "%s\n" "${AUTO_CHANGELOG}" >> RELEASE_BODY.md
          fi

          if [ ! -s RELEASE_BODY.md ]; then
            printf "_No user-facing changes in this release_\n" > RELEASE_BODY.md
          fi
        env:
          MANUAL: ${{ steps.spec.outputs.manual_body }}
          AUTO_CHANGELOG: ${{ steps.changelog.outputs.changelog }}
          NO_CHANGELOG: ${{ steps.spec.outputs.no_changelog }}

      - name: "Create GitHub Release"
        if: steps.spec.outputs.missing == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name:  ${{ steps.tag.outputs.tag }}
          name:      ${{ steps.spec.outputs.title }}
          body_path: RELEASE_BODY.md
          prerelease: ${{ steps.spec.outputs.pre_release }}
          files:     ${{ steps.jar_named.outputs.file }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "Reset release spec (blank template) on main"
        if: steps.spec.outputs.missing == 'false'
        run: |
          set -e
          printf "%s\n" \
            "Release Title:" \
            "Release Tag Number:" \
            "Custom File Name:" \
            "" \
            "[ ] No Changelog" \
            "[ ] Pre-Release" \
            "" \
            "---CONTENT---" \
            "---END---" > .github/release-spec.md

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .github/release-spec.md
          git commit -m "chore: reset release spec (main)" || true
          git push origin HEAD:main || true

      - name: "Reset release spec (blank template) on dev"
        if: steps.spec.outputs.missing == 'false'
        run: |
          set -e
          git fetch origin dev || true
          git checkout -B tmp-reset-dev origin/dev

          printf "%s\n" \
            "Release Title:" \
            "Release Tag Number:" \
            "Custom File Name:" \
            "" \
            "[ ] No Changelog" \
            "[ ] Pre-Release" \
            "" \
            "---CONTENT---" \
            "---END---" > .github/release-spec.md

          git add .github/release-spec.md
          git commit -m "chore: reset release spec (dev)" || true
          git push origin HEAD:dev || true