name: Release on merge to main

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  release:
    if: ${{ github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Guard: must target main"
        run: |
          echo "Base branch: ${{ github.event.pull_request.base.ref }}"
          if [ "${{ github.event.pull_request.base.ref }}" != "main" ]; then
            echo "Not targeting main; exiting."
            exit 1
          fi

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Build (skip tests for speed)
        run: mvn -B -ntp -DskipTests clean package

      - name: Find built jar
        id: jar
        run: |
          file=$(ls -1 target/*.jar | grep -v -E 'sources|javadoc' | head -n1)
          echo "file=$file" >> "$GITHUB_OUTPUT"

      - name: Read version from pom.xml
        id: ver
        run: |
          v=$(mvn -q -Dexec.executable=echo -Dexec.args='${project.version}' --non-recursive org.codehaus.mojo:exec-maven-plugin:3.5.1:exec)
          echo "version=$v" >> "$GITHUB_OUTPUT"
          echo "tag=v${v}" >> "$GITHUB_OUTPUT"
          echo "name=DiscordLogger v${v}" >> "$GITHUB_OUTPUT"

      - name: Parse release options (pre-release, custom tag, title)
        id: relopts
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request?.body || '';
            const pre = /\[\s*x\s*\]\s*Pre-release/i.test(body);
            const tagMatch   = body.match(/<!--\s*RELEASE-TAG:START\s*-->\s*([\s\S]*?)\s*<!--\s*RELEASE-TAG:END\s*-->/i);
            const titleMatch = body.match(/<!--\s*RELEASE-TITLE:START\s*-->\s*([\s\S]*?)\s*<!--\s*RELEASE-TITLE:END\s*-->/i);
            const jarMatch   = body.match(/<!--\s*CUSTOM-JAR-NAME:START\s*-->\s*([\s\S]*?)\s*<!--\s*CUSTOM-JAR-NAME:END\s*-->/i);

            function clean(s) { return (s || '').trim(); }

            core.setOutput('pre',   pre ? 'true' : 'false');
            core.setOutput('tag',   clean(tagMatch && tagMatch[1]));
            core.setOutput('title', clean(titleMatch && titleMatch[1]));
            core.setOutput('jar',   clean(jarMatch && jarMatch[1]));



      - name: Rename jar for release
        id: jar_named
        run: |
          ver="${{ steps.ver.outputs.version }}"
          ver="${ver%-SNAPSHOT}"

          # Default filename if no custom name provided
          default_name="DiscordLogger-v${ver}.jar"

          # Use custom jar base name if provided (no '.jar' needed), else default
          base="${{ steps.relopts.outputs.jar }}"
          if [ -n "$base" ]; then
            # strip any accidental .jar and sanitize a bit
            base="${base%.jar}"
            # allow letters, numbers, space, dot, dash, underscore
            safe_base="$(printf '%s' "$base" | tr -cd '[:alnum:]._ -')"
            [ -z "$safe_base" ] && safe_base="DiscordLogger-v${ver}"
            new="${safe_base}.jar"
          else
            new="$default_name"
          fi

          src="${{ steps.jar.outputs.file }}"
          dest="target/${new}"

          echo "Renaming artifact:"
          echo "  src : $src"
          echo "  dest: $dest"

          cp "$src" "$dest"
          echo "file=$dest" >> "$GITHUB_OUTPUT"


      - name: Label integration PR as skip-changelog
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['skip-changelog']
            });

      - name: Determine previous main release baseline
        id: prev
        run: |
          set -euo pipefail
          git fetch origin main --force
          git fetch --tags --force
          prevTag=$(git tag --list 'v[0-9]*.[0-9]*.[0-9]*' --merged origin/main | sort -V | tail -n 1 || true)
          if [ -n "$prevTag" ]; then
              prevSha=$(git rev-list -n 1 "$prevTag")
          else
              prevSha=$(git rev-list --max-parents=0 origin/main)
          fi
          echo "tag=$prevTag" >> "$GITHUB_OUTPUT"
          echo "sha=$prevSha" >> "$GITHUB_OUTPUT"


      - name: Create tag (or fallback if tag exists)
        id: tag
        run: |
          TAG="${{ steps.relopts.outputs.tag }}"
          if [ -z "$TAG" ]; then
            TAG="${{ steps.ver.outputs.tag }}"
          fi

          if git rev-parse -q --verify "refs/tags/$TAG" >/dev/null; then
            TAG="${TAG}-r${GITHUB_RUN_NUMBER}"
            echo "Existing tag found, using fallback: $TAG"
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "${{ steps.ver.outputs.name }}"
          git push origin "$TAG"


      - name: Detect "No changelog" checkbox
        id: skip
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request?.body || '';
            const checked = /\[\s*x\s*\]\s*No changelog for this release/i.test(body);
            core.setOutput('skip', checked ? 'true' : 'false');

      - name: Debug compare refs
        run: |
          echo "prev.tag=${{ steps.prev.outputs.tag }}"
          echo "prev.sha=${{ steps.prev.outputs.sha }}"
          echo "to.tag=${{ steps.tag.outputs.tag }}"



      - name: Build changelog for this release (commit-based)
        if: ${{ steps.skip.outputs.skip != 'true' }}
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v5
        with:
          configuration: .github/release-changelog-builder-config.json
          fromTag: ${{ steps.prev.outputs.sha }}   # <-- use SHA, not tag name
          toTag:   ${{ steps.tag.outputs.tag }}    # new tag
          fetchViaCommits: "true"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}



      - name: Compose release body (PR notes + optional changelog)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = context.payload.pull_request?.body || '';
            const m = body.match(/<!--\s*RELEASE-NOTES:START\s*-->([\s\S]*?)<!--\s*RELEASE-NOTES:END\s*-->/i);
            const notes = (m ? m[1] : '').trim();
            const skip = process.env.SKIP === 'true';
            const changelogRaw = skip ? '' : (process.env.CHANGELOG || '').trim();

            let out = '';
            if (notes) {
              out += notes.trim();
            }
            if (changelogRaw) {
              // add a blank line + header, then the changelog body
              out += (out ? '\n\n' : '') + '# Changelog\n\n' + changelogRaw + '\n';
            }
            if (!out) {
              out = '_No user-facing changes in this release_\\n';
            }

            fs.writeFileSync('RELEASE_BODY.md', out);
        env:
          SKIP: ${{ steps.skip.outputs.skip }}
          CHANGELOG: ${{ steps.changelog.outputs.changelog }}



      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: ${{ steps.relopts.outputs.title != '' && steps.relopts.outputs.title || steps.ver.outputs.name }}
          prerelease: ${{ steps.relopts.outputs.pre == 'true' }}
          body_path: RELEASE_BODY.md           # (if youâ€™re composing notes+changelog)
          files: ${{ steps.jar_named.outputs.file }}

