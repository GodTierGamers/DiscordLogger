name: Release on merge to main

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  release:
    if: ${{ github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Guard: must target main"
        run: |
          echo "Base branch: ${{ github.event.pull_request.base.ref }}"
          if [ "${{ github.event.pull_request.base.ref }}" != "main" ]; then
            echo "Not targeting main; exiting."
            exit 1
          fi

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Build (skip tests for speed)
        run: mvn -B -ntp -DskipTests clean package

      - name: Find built jar
        id: jar
        run: |
          file=$(ls -1 target/*.jar | grep -v -E 'sources|javadoc' | head -n1)
          echo "file=$file" >> "$GITHUB_OUTPUT"

      - name: Read version from pom.xml
        id: ver
        run: |
          v=$(mvn -q -Dexec.executable=echo -Dexec.args='${project.version}' --non-recursive org.codehaus.mojo:exec-maven-plugin:3.5.1:exec)
          echo "version=$v" >> "$GITHUB_OUTPUT"
          echo "tag=v${v}" >> "$GITHUB_OUTPUT"
          echo "name=DiscordLogger v${v}" >> "$GITHUB_OUTPUT"

      - name: Label integration PR as skip-changelog
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['skip-changelog']
            });

      - name: Determine previous main release tag
        id: prev
        run: |
          git fetch --tags --force
          # Only pick strict semver tags on main: vMAJOR.MINOR.PATCH
          prev=$(git tag --list 'v[0-9]*.[0-9]*.[0-9]*' --merged origin/main | sort -V | tail -n 1)
          echo "prev=$prev" >> "$GITHUB_OUTPUT" 

      - name: Build changelog for this release
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v4
        with:
          configuration: .github/release-changelog-builder-config.json
          fromTag: ${{ steps.prev.outputs.prev }}
          toTag:   ${{ steps.ver.outputs.tag }}
          fetchViaCommits: "true"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create tag (or fallback if tag exists)
        id: tag
        run: |
          TAG="${{ steps.ver.outputs.tag }}"
          if git rev-parse -q --verify "refs/tags/$TAG" >/dev/null; then
            TAG="${TAG}-r${GITHUB_RUN_NUMBER}"
            echo "Existing tag found, using fallback: $TAG"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "${{ steps.ver.outputs.name }}"
          git push origin "$TAG"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: ${{ steps.ver.outputs.name }}
          body: ${{ steps.changelog.outputs.changelog }}
          files: ${{ steps.jar.outputs.file }}
